name: Codacy Security Scan

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]
  schedule:
    - cron: '17 22 * * 4'

permissions:
  contents: read

jobs:
  codacy-security-scan:
    permissions:
      contents: read
      security-events: write
      actions: read

    name: Codacy Security Scan
    runs-on: ubuntu-latest
    steps:
jobs:
  codacy-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install Codacy Analysis CLI
      run: |
        curl -LsS https://github.com/codacy/codacy-analysis-cli/releases/download/5.2.0/codacy-analysis-cli-5.2.0-linux-x64.zip -o codacy-analysis-cli.zip
        unzip codacy-analysis-cli.zip
        chmod +x codacy-analysis-cli
        sudo mv codacy-analysis-cli /usr/local/bin/

    - name: Run Codacy Analysis CLI
      run: |
        cd src/app-service
        codacy-analysis-cli --project-token ${{ secrets.CODACY_PROJECT_TOKEN }} --verbose --output results.sarif --format sarif --gh-code-scanning-compat true --max-allowed-issues 2147483647

      # Upload the SARIF file generated in the previous step
    - name: Upload SARIF results file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: src/app-service/results.sarif
